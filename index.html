<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu della Settimana</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="L'asilo a portata di mano">
    <meta name="theme-color" content="#FF6B35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Menu Asilo">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* General styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background: linear-gradient(to bottom, #FFF9E6 0%, #FFE5E5 100%);
            color: #333;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header styles */
        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .week-info {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        /* Navigation tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            color: #666;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 107, 53, 0.4);
        }

        @media (hover: hover) {
            .nav-tab:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            }
        }

        /* Selectors */
        .selector-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .selector-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        .selector-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .selector-btn {
            padding: 0.6rem 1.2rem;
            border: 2px solid #FF6B35;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            color: #FF6B35;
        }

        .selector-btn.active {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            border-color: #FF6B35;
            box-shadow: 0 3px 8px rgba(255, 107, 53, 0.3);
        }

        @media (hover: hover) {
            .selector-btn:hover:not(.active) {
                background: #FFE5D9;
                transform: translateY(-2px);
            }
        }

        /* Control buttons - Top right position */
        .controls {
            position: fixed;
            right: 1rem;
            top: 1rem;
            display: flex;
            flex-direction: row;
            gap: 0.5rem;
            z-index: 1000;
        }

        .btn {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            border: 3px solid white;
        }

        @media (hover: hover) {
            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 10px rgba(255, 107, 53, 0.4);
            }
        }

        .btn-secondary {
            background: white;
            color: #FF6B35;
            border: 3px solid #FF6B35;
        }

        @media (hover: hover) {
            .btn-secondary:hover {
                background: #FFE5D9;
                transform: translateY(-2px);
            }
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* Hidden sections */
        .hidden {
            display: none;
        }

        /* Timeline for all weeks view */
        .timeline-container {
            position: sticky;
            top: 0;
            z-index: 999;
            background: white;
            padding: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            border-radius: 0 0 15px 15px;
        }

        .timeline {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 3px;
            background: #e0e0e0;
            transform: translateY(-50%);
            z-index: 0;
        }

        .timeline-item {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timeline-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            color: #999;
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }

        .timeline-item.current .timeline-dot {
            border-color: #4CAF50;
            background: white;
            color: #4CAF50;
            position: relative;
        }

        .timeline-item.current .timeline-dot::after {
            content: '‚óè';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 1.2rem;
            color: #4CAF50;
            animation: pulse-current 2s ease-in-out infinite;
        }

        @keyframes pulse-current {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        .timeline-item.active .timeline-dot {
            border-color: #FF6B35;
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .timeline-item.current.active .timeline-dot {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .timeline-label {
            font-size: 0.75rem;
            color: #999;
            font-weight: 600;
            white-space: nowrap;
        }

        .timeline-item.current .timeline-label {
            color: #4CAF50;
            font-weight: 700;
        }

        .timeline-item.active .timeline-label {
            color: #FF6B35;
            font-weight: 700;
        }

        .timeline-item.current.active .timeline-label {
            color: #4CAF50;
        }

        /* Quick view section */
        #quick-view {
            margin-bottom: 1.5rem;
        }

        .quick-view-header {
            text-align: center;
            padding: 1rem 1.5rem;
            border-radius: 20px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .quick-view-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .quick-view-header h2::before {
            content: 'üìÖ ';
            font-size: 1.3rem;
        }

        .quick-view-header.week-1 {
            background: linear-gradient(135deg, #FFFACD 0%, #FFE66D 100%);
        }

        .quick-view-header.week-1 h2 {
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        .quick-view-header.week-2 {
            background: linear-gradient(135deg, #FFE66D 0%, #FFD93D 100%);
        }

        .quick-view-header.week-2 h2 {
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        .quick-view-header.week-3 {
            background: linear-gradient(135deg, #FFD93D 0%, #FFC926 100%);
        }

        .quick-view-header.week-3 h2 {
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        .quick-view-header.week-4 {
            background: linear-gradient(135deg, #FFC926 0%, #FFB300 100%);
        }

        .quick-view-header.week-4 h2 {
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        /* Week section */
        .week-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: 20px;
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
        }

        /* Color coding for weeks - Tonalit√† diverse di giallo */
        .week-section.week-1 {
            background: linear-gradient(135deg, #FFFACD 0%, #FFE66D 100%);
            box-shadow: 0 4px 8px rgba(255, 250, 205, 0.3);
        }

        .week-section.week-1 .week-title {
            color: #2c3e50;
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        .week-section.week-1 .day-card:not(.today):not(.tomorrow) {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #FFE66D;
        }

        .week-section.week-2 {
            background: linear-gradient(135deg, #FFE66D 0%, #FFD93D 100%);
            box-shadow: 0 4px 8px rgba(255, 230, 109, 0.3);
        }

        .week-section.week-2 .week-title {
            color: #2c3e50;
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        .week-section.week-2 .day-card:not(.today):not(.tomorrow) {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #FFD93D;
        }

        .week-section.week-3 {
            background: linear-gradient(135deg, #FFD93D 0%, #FFC926 100%);
            box-shadow: 0 4px 8px rgba(255, 217, 61, 0.3);
        }

        .week-section.week-3 .week-title {
            color: #2c3e50;
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        .week-section.week-3 .day-card:not(.today):not(.tomorrow) {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #FFC926;
        }

        .week-section.week-4 {
            background: linear-gradient(135deg, #FFC926 0%, #FFB300 100%);
            box-shadow: 0 4px 8px rgba(255, 201, 38, 0.3);
        }

        .week-section.week-4 .week-title {
            color: #2c3e50;
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        .week-section.week-4 .day-card:not(.today):not(.tomorrow) {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #FFB300;
        }

        /* Current week enhancement */
        .week-section.current-week {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3) !important;
            border: 3px solid rgba(255, 255, 255, 0.8);
        }

        .week-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #eee;
            color: #2c3e50;
        }

        .current-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
            margin-left: 1rem;
            font-weight: 600;
            border: 2px solid white;
            box-shadow: 0 3px 6px rgba(255, 107, 53, 0.3);
        }

        /* Menu grid */
        .menu-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .menu-container.compact {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        /* Day card */
        .day-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            min-height: 200px;
            border: 2px solid #f0f0f0;
        }

        @media (hover: hover) {
            .day-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            }
        }

        @media (hover: none) {
            .day-card:active {
                transform: scale(0.98);
            }
        }

        .week-section.current-week .day-card:not(.today):not(.tomorrow) {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .week-section .day-card.today {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
        }

        .week-section .day-card.tomorrow {
            background-color: #fffbf0 !important;
        }

        .day-card h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #eee;
            text-transform: capitalize;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .day-date {
            font-size: 0.85rem;
            color: #7f8c8d;
            font-weight: 500;
            margin-left: 0.5rem;
        }
        
        .day-card.today .day-date {
            color: #FF6B35;
            font-weight: 600;
        }
        
        .day-card.tomorrow .day-date {
            color: #38A3A5;
            font-weight: 600;
        }

        .day-label {
            font-size: 0.75rem;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .today-label {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(255, 107, 53, 0.3);
        }

        .tomorrow-label {
            background: linear-gradient(135deg, #38A3A5 0%, #57C5B6 100%);
            color: white;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(56, 163, 165, 0.3);
        }

        .meal {
            margin-bottom: 1rem;
        }

        .meal h3 {
            color: #FF6B35;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .meal p {
            color: #555;
            font-size: 0.95rem;
        }

        /* Today's card - Strong emphasis per asilo */
        .day-card.today {
            border: 4px solid #FF6B35;
            background: linear-gradient(135deg, #FFE66D 0%, #FFB4B4 100%);
            box-shadow: 0 10px 20px rgba(255, 107, 53, 0.4);
        }

        .day-card.today h2 {
            color: #FF6B35;
            font-weight: 700;
            font-size: 1.4rem;
        }

        .day-card.tomorrow {
            border: 3px solid #95E1D3;
            background: linear-gradient(135deg, #E3FDFD 0%, #CBF1F5 100%);
            opacity: 1;
        }

        .day-card.tomorrow h2 {
            color: #38A3A5;
            font-weight: 600;
        }

        .day-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            color: white;
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);
        }

        .today-badge {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            font-size: 1rem;
            padding: 0.5rem 1.2rem;
            animation: pulse 2s ease-in-out infinite;
            border: 2px solid white;
        }

        .tomorrow-badge {
            background: linear-gradient(135deg, #38A3A5 0%, #57C5B6 100%);
            font-size: 0.85rem;
            border: 2px solid white;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 3px 8px rgba(255, 107, 53, 0.4);
            }
            50% {
                box-shadow: 0 5px 15px rgba(255, 107, 53, 0.7);
                transform: scale(1.05);
            }
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* Responsive adjustments */
        
        /* Tablets and small desktops */
        @media (max-width: 1024px) {
            .menu-container:not(.compact) {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                gap: 1rem;
            }
            
            .week-section {
                padding: 1.25rem;
            }
        }
        
        /* Tablets portrait */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .week-info {
                font-size: 1rem;
            }
            
            .week-title {
                font-size: 1.5rem;
            }
            
            .current-badge {
                display: block;
                margin: 0.5rem 0 0 0;
                width: fit-content;
            }
            
            .menu-container:not(.compact) {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .week-section {
                margin-bottom: 1.5rem;
                padding: 1rem;
            }
        }
        
        /* Mobile devices */
        @media (max-width: 480px) {
            .container {
                padding: 0.5rem;
            }
            
            header {
                margin-bottom: 1rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .week-info {
                font-size: 0.9rem;
            }
            
            .controls {
                position: fixed;
                right: 0.5rem;
                top: 0.5rem;
                flex-direction: column;
                gap: 0.35rem;
            }
            
            .btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.7rem;
                border-radius: 6px;
            }
            
            .quick-view-header {
                padding: 0.75rem 1rem;
                margin-bottom: 0.75rem;
            }
            
            .quick-view-header h2 {
                font-size: 1.2rem;
            }
            
            .quick-view-header h2::before {
                font-size: 1rem;
            }
            
            .timeline-container {
                padding: 0.75rem 0.5rem;
            }
            
            .timeline-dot {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .timeline-label {
                font-size: 0.65rem;
            }
            
            .week-section {
                margin-bottom: 1.5rem;
                padding: 0.75rem;
            }
            
            .week-title {
                font-size: 1.3rem;
                margin-bottom: 1rem;
            }
            
            .current-badge {
                font-size: 0.75rem;
                padding: 0.2rem 0.6rem;
            }
            
            .menu-container {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .day-card {
                padding: 1rem;
            }
            
            .day-card h2 {
                font-size: 1.2rem;
            }
            
            .meal h3 {
                font-size: 0.9rem;
            }
            
            .meal p {
                font-size: 0.85rem;
            }
            
            .day-badge {
                top: -8px;
                right: 10px;
                font-size: 0.7rem;
                padding: 0.2rem 0.6rem;
            }
            
            footer {
                margin-top: 1.5rem;
                font-size: 0.8rem;
            }
        }
        
        /* Extra small devices */
        @media (max-width: 360px) {
            .container {
                padding: 0.5rem 0.25rem;
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            .week-section {
                padding: 0.5rem;
            }
            
            .week-title {
                font-size: 1.1rem;
            }
            
            .day-card {
                padding: 0.75rem;
            }
            
            .current-badge {
                font-size: 0.7rem;
            }
        }

        /* Activities styles */
        .activities-container {
            margin-bottom: 2rem;
        }

        .activity-week {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .activity-week-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #eee;
            color: #2c3e50;
            text-align: center;
        }

        .activities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .activity-day-card {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE5E5 100%);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        @media (hover: hover) {
            .activity-day-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            }
        }

        .activity-day-card h3 {
            color: #FF6B35;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #FFE5D9;
            font-size: 1.2rem;
        }

        .activity-moment {
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #FF6B35;
        }

        .activity-moment-title {
            font-weight: 600;
            color: #555;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .activity-moment-content {
            color: #333;
            font-size: 0.9rem;
        }

        .activity-day-card.today {
            border: 3px solid #FF6B35;
            box-shadow: 0 8px 16px rgba(255, 107, 53, 0.3);
        }

        .activity-day-card.tomorrow {
            border: 3px solid #57C5B6;
            box-shadow: 0 8px 16px rgba(56, 163, 165, 0.3);
        }

        /* Preferences section */
        .preferences-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .preferences-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .preferences-header h2 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .preferences-header p {
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        .add-combination-btn {
            display: block;
            margin: 0 auto 2rem;
            padding: 0.8rem 2rem;
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
        }

        @media (hover: hover) {
            .add-combination-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 15px rgba(76, 175, 80, 0.4);
            }
        }

        .combinations-list {
            display: grid;
            gap: 1.5rem;
        }

        .combination-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .combination-card.highlight {
            border-color: #FFD700;
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .combination-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #eee;
        }

        .combination-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .combination-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn.edit {
            background: #3498db;
            color: white;
        }

        .action-btn.delete {
            background: #e74c3c;
            color: white;
        }

        .action-btn.move {
            background: #95a5a6;
            color: white;
            padding: 0.4rem 0.6rem;
        }

        @media (hover: hover) {
            .action-btn:hover {
                transform: scale(1.05);
            }
        }

        .order-controls {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }

        .combination-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .combination-section {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE5E5 100%);
            padding: 1rem;
            border-radius: 15px;
        }

        .combination-section h4 {
            color: #FF6B35;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .combination-section p {
            color: #555;
            font-size: 0.9rem;
            margin: 0.25rem 0;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #FF6B35;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .modal-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.save {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
        }

        .modal-btn.cancel {
            background: #95a5a6;
            color: white;
        }

        @media (hover: hover) {
            .modal-btn:hover {
                transform: translateY(-2px);
            }
        }

        /* Favorites section */
        .favorites-container {
            margin-bottom: 2rem;
        }

        .favorites-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .favorites-header h2 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .favorites-grid {
            display: grid;
            gap: 2rem;
        }

        .favorite-combination {
            background: white;
            border: 4px solid #FFD700;
            border-radius: 25px;
            padding: 2rem;
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.4);
        }

        .favorite-combination-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #FFD700;
        }

        .favorite-combination-header h3 {
            color: #FF6B35;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .favorite-combination-header .combination-info {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .combination-badge {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .day-toggle {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 1rem 0;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .day-toggle-btn {
            padding: 0.6rem 1.5rem;
            border: 2px solid transparent;
            background: white;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .day-toggle-btn.active {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            border-color: #4CAF50;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }

        @media (hover: hover) {
            .day-toggle-btn:not(.active):hover {
                background: #e9ecef;
                transform: translateY(-2px);
            }
        }

        .favorite-day-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .favorite-menu-section,
        .favorite-activities-section {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE5E5 100%);
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .favorite-section-title {
            color: #FF6B35;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #FFE5D9;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .favorite-menu-items .meal {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: white;
            border-radius: 12px;
            border-left: 4px solid #FF6B35;
        }

        .favorite-menu-items .meal h4 {
            color: #FF6B35;
            font-size: 1rem;
            margin-bottom: 0.4rem;
        }

        .favorite-menu-items .meal p {
            color: #333;
            font-size: 0.95rem;
        }

        .favorite-activities-list .activity-moment {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: white;
            border-radius: 12px;
            border-left: 4px solid #4CAF50;
        }

        .favorite-activities-list .activity-moment-title {
            font-weight: 600;
            color: #4CAF50;
            font-size: 0.85rem;
            margin-bottom: 0.35rem;
        }

        .favorite-activities-list .activity-moment-content {
            color: #333;
            font-size: 0.9rem;
        }

        .no-data-message {
            text-align: center;
            padding: 2rem;
            color: #999;
            font-style: italic;
        }

        @media (max-width: 968px) {
            .favorite-day-view {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .combination-content,
            .favorite-split {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>L'asilo a portata di mano</h1>
        </header>
        
        <div class="controls">
            <button class="btn btn-primary" id="btn-install" style="display: none;">üì≤ Installa App</button>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab" onclick="switchTab('favorites')">‚≠ê I Miei Preferiti</button>
            <button class="nav-tab active" onclick="switchTab('menu')">üìã Menu</button>
            <button class="nav-tab" onclick="switchTab('activities')">üé® Attivit√†</button>
            <button class="nav-tab" onclick="switchTab('preferences')">‚öôÔ∏è Preferenze</button>
        </div>
        
        <!-- MENU SECTION -->
        <div id="menu-section">
            <!-- Menu Type Selector -->
            <div class="selector-container">
                <span class="selector-label">Tipo Menu:</span>
                <div class="selector-buttons">
                    <button class="selector-btn active" onclick="selectMenuType('nido')">üë∂ Nido</button>
                    <button class="selector-btn" onclick="selectMenuType('infanzia')">üéì Infanzia</button>
                </div>
            </div>

            <button class="btn btn-secondary" id="btn-all-weeks" onclick="toggleAllWeeks()" style="display: block; margin: 0 auto 1.5rem;">Tutte le Settimane</button>
            
            <div id="quick-view">
                <!-- Quick view (all days of current week) will be generated here -->
            </div>
            
            <div id="all-weeks-container" class="hidden">
                <div class="timeline-container">
                    <div class="timeline" id="timeline">
                        <div class="timeline-item active" data-week="1" onclick="scrollToWeek(1)">
                            <div class="timeline-dot">1</div>
                            <div class="timeline-label">Sett. 1</div>
                        </div>
                        <div class="timeline-item" data-week="2" onclick="scrollToWeek(2)">
                            <div class="timeline-dot">2</div>
                            <div class="timeline-label">Sett. 2</div>
                        </div>
                        <div class="timeline-item" data-week="3" onclick="scrollToWeek(3)">
                            <div class="timeline-dot">3</div>
                            <div class="timeline-label">Sett. 3</div>
                        </div>
                        <div class="timeline-item" data-week="4" onclick="scrollToWeek(4)">
                            <div class="timeline-dot">4</div>
                            <div class="timeline-label">Sett. 4</div>
                        </div>
                    </div>
                </div>
                <div id="weeks-content">
                    <!-- All weeks will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- ACTIVITIES SECTION -->
        <div id="activities-section" class="hidden">
            <!-- Activities Group Selector -->
            <div class="selector-container">
                <span class="selector-label">Gruppo:</span>
                <div class="selector-buttons">
                    <button class="selector-btn active" onclick="selectActivityGroup('nido')">üë∂ Nido</button>
                    <button class="selector-btn" onclick="selectActivityGroup('primavera')">üå∏ Primavera</button>
                    <button class="selector-btn" onclick="selectActivityGroup('infanzia1')">üéì Infanzia 1</button>
                    <button class="selector-btn" onclick="selectActivityGroup('infanzia2')">üéì Infanzia 2</button>
                </div>
            </div>

            <div id="activities-content" class="activities-container">
                <!-- Activities will be generated by JavaScript -->
            </div>
        </div>

        <!-- FAVORITES SECTION -->
        <div id="favorites-section" class="hidden">
            <div class="favorites-container">
                <div class="favorites-header">
                    <h2>‚≠ê I tuoi cuccioli</h2>
                </div>
                <div id="favorites-content" class="favorites-grid">
                    <!-- Favorites will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- PREFERENCES SECTION -->
        <div id="preferences-section" class="hidden">
            <div class="preferences-container">
                <div class="preferences-header">
                    <h2>‚öôÔ∏è Gestisci i tuoi cuccioli</h2>
                    <p>Aggiungi un cucciolo personalizzando menu e attivit√† per un accesso rapido</p>
                </div>
                
                <button class="add-combination-btn" onclick="openCombinationModal()">
                    ‚ûï Aggiungi cucciolo
                </button>

                <div id="combinations-list" class="combinations-list">
                    <!-- Combinations will be generated by JavaScript -->
                </div>
            </div>
        </div>
        
        <footer>
            <p>üíõ Con amore per i nostri cuccioli</p>
        </footer>
    </div>

    <!-- MODAL FOR ADDING/EDITING COMBINATIONS -->
    <div id="combination-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Nuovo cucciolo</h3>
            </div>
            
            <form id="combination-form">
                <div class="form-group">
                    <label for="combination-name">Nome Combinazione</label>
                    <input type="text" id="combination-name" placeholder="Es: Mio Figlio - Nido" required>
                </div>

                <div class="form-group">
                    <label for="combination-menu">Tipo Menu</label>
                    <select id="combination-menu" required>
                        <option value="nido">üë∂ Nido</option>
                        <option value="infanzia">üéì Infanzia</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="combination-activity">Gruppo Attivit√†</label>
                    <select id="combination-activity" required>
                        <option value="nido">üë∂ Nido</option>
                        <option value="primavera">üå∏ Primavera</option>
                        <option value="infanzia1">üéì Infanzia 1</option>
                        <option value="infanzia2">üéì Infanzia 2</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" onclick="closeCombinationModal()">Annulla</button>
                    <button type="submit" class="modal-btn save">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Menu data now loaded from external file: menu-data.txt -->

    <script>
        // *** CONFIGURAZIONE DATA DI INIZIO ***
        // Specificare qui il luned√¨ della prima settimana nel formato YYYY-MM-DD
        const WEEK_1_MONDAY = '2025-10-06';
        
        // Current selections
        let currentMenuType = 'nido';
        let currentActivityGroup = 'nido';
        let currentTab = 'menu';
        
        // Menu data will be loaded from external file
        let MENU_NIDO = {
            0: {},
            1: {},
            2: {},
            3: {}
        };

        let MENU_INFANZIA = {
            0: {},
            1: {},
            2: {},
            3: {}
        };

        // Activities data
        let ACTIVITIES = {
            nido: {},
            primavera: {},
            infanzia1: {},
            infanzia2: {}
        };

        // Day mapping from number to Italian name
        const DAY_NAMES = {
            1: 'Luned√¨',
            2: 'Marted√¨',
            3: 'Mercoled√¨',
            4: 'Gioved√¨',
            5: 'Venerd√¨',
            6: 'Sabato'
        };

        // Activity moments names
        const ACTIVITY_MOMENTS = [
            'üåÖ Attivit√† del Mattino',
            'üåÜ Attivit√† del Pomeriggio'
        ];

        // Combinations management
        let combinations = [];
        let editingCombinationId = null;

        // Load combinations from localStorage
        function loadCombinations() {
            const stored = localStorage.getItem('lunchBuddiesCombinations');
            if (stored) {
                try {
                    combinations = JSON.parse(stored);
                } catch (e) {
                    console.error('Error loading combinations:', e);
                    combinations = [];
                }
            }
        }

        // Save combinations to localStorage
        function saveCombinations() {
            localStorage.setItem('lunchBuddiesCombinations', JSON.stringify(combinations));
        }

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Load all data files
        async function loadAllDataFiles() {
            await loadMenuNido();
            await loadMenuInfanzia();
            await loadActivities();
        }

        // Load menu Nido from external text file
        async function loadMenuNido() {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`menu-nido.txt?t=${timestamp}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) {
                    throw new Error('Impossibile caricare il file menu-nido.txt');
                }
                const text = await response.text();
                parseMenuFile(text, MENU_NIDO);
                console.log('Menu Nido caricato con successo');
            } catch (error) {
                console.error('Errore nel caricamento del menu Nido:', error);
            }
        }

        // Load menu Infanzia from external text file
        async function loadMenuInfanzia() {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`menu-infanzia.txt?t=${timestamp}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) {
                    throw new Error('Impossibile caricare il file menu-infanzia.txt');
                }
                const text = await response.text();
                parseMenuFileInfanzia(text, MENU_INFANZIA);
                console.log('Menu Infanzia caricato con successo');
            } catch (error) {
                console.error('Errore nel caricamento del menu Infanzia:', error);
            }
        }

        // Load activities from external text file
        async function loadActivities() {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`activities.txt?t=${timestamp}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) {
                    throw new Error('Impossibile caricare il file activities.txt');
                }
                const text = await response.text();
                parseActivitiesFile(text);
                console.log('Attivit√† caricate con successo');
            } catch (error) {
                console.error('Errore nel caricamento delle attivit√†:', error);
            }
        }

        // Parse menu file for Nido (formato: settimana|giorno|primo|secondo|frutta)
        function parseMenuFile(text, menuObj) {
            const lines = text.split('\n');
            
            for (const line of lines) {
                // Skip comments and empty lines
                if (line.trim().startsWith('#') || line.trim() === '') {
                    continue;
                }
                
                // Parse line format: settimana|giorno|primo|secondo|frutta
                const parts = line.split('|').map(p => p.trim());
                
                if (parts.length === 5) {
                    const weekNum = parseInt(parts[0]) - 1; // Convert to 0-based index
                    const dayNum = parseInt(parts[1]);
                    const primo = parts[2];
                    const secondo = parts[3];
                    const frutta = parts[4];
                    
                    const dayName = DAY_NAMES[dayNum];
                    
                    if (dayName && weekNum >= 0 && weekNum <= 3) {
                        menuObj[weekNum][dayName] = { primo, secondo, frutta };
                    }
                }
            }
        }

        // Parse menu file for Infanzia (formato: settimana|giorno|primo|secondo|frutta o settimana|giorno|primo|secondo|contorno|frutta)
        function parseMenuFileInfanzia(text, menuObj) {
            const lines = text.split('\n');
            
            for (const line of lines) {
                // Skip comments and empty lines
                if (line.trim().startsWith('#') || line.trim() === '') {
                    continue;
                }
                
                // Parse line format: can be 5 or 6 parts
                const parts = line.split('|').map(p => p.trim());
                
                // Support both formats: with and without contorno
                if (parts.length === 5) {
                    // Format: settimana|giorno|primo|secondo|frutta
                    const weekNum = parseInt(parts[0]) - 1;
                    const dayNum = parseInt(parts[1]);
                    const primo = parts[2];
                    const secondo = parts[3];
                    const frutta = parts[4];
                    
                    const dayName = DAY_NAMES[dayNum];
                    
                    if (dayName && weekNum >= 0 && weekNum <= 3) {
                        menuObj[weekNum][dayName] = { primo, secondo, frutta };
                    }
                } else if (parts.length === 6) {
                    // Format: settimana|giorno|primo|secondo|contorno|frutta
                    const weekNum = parseInt(parts[0]) - 1;
                    const dayNum = parseInt(parts[1]);
                    const primo = parts[2];
                    const secondo = parts[3];
                    const contorno = parts[4];
                    const frutta = parts[5];
                    
                    const dayName = DAY_NAMES[dayNum];
                    
                    if (dayName && weekNum >= 0 && weekNum <= 3) {
                        menuObj[weekNum][dayName] = { primo, secondo, contorno, frutta };
                    }
                }
            }
        }

        // Parse activities file
        function parseActivitiesFile(text) {
            const lines = text.split('\n');
            
            for (const line of lines) {
                // Skip comments and empty lines
                if (line.trim().startsWith('#') || line.trim() === '') {
                    continue;
                }
                
                // Parse line format: gruppo|giorno|attivita_mattino|attivita_pomeriggio
                const parts = line.split('|').map(p => p.trim());
                
                if (parts.length === 4) {
                    const group = parts[0];
                    const dayNum = parseInt(parts[1]);
                    const moments = parts.slice(2);
                    
                    const dayName = DAY_NAMES[dayNum];
                    
                    if (dayName && ACTIVITIES[group]) {
                        ACTIVITIES[group][dayName] = moments;
                    }
                }
            }
        }

        // Get current menu based on selection
        function getCurrentMenu() {
            return currentMenuType === 'nido' ? MENU_NIDO : MENU_INFANZIA;
        }

        function getWeekNumber(date = new Date()) {
            // Calcola il numero di settimana basato sulla data di inizio configurata
            const startDate = new Date(WEEK_1_MONDAY);
            const currentDate = new Date(date);
            
            // Calcola la differenza in giorni
            const diffTime = currentDate - startDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Calcola il numero di settimana (0-3 in ciclo di 4 settimane)
            const weeksSinceStart = Math.floor(diffDays / 7);
            let weekNum = weeksSinceStart % 4;
            
            // Gestisci il caso di date prima dell'inizio (numeri negativi)
            if (weekNum < 0) {
                weekNum = (weekNum + 4) % 4;
            }
            
            return weekNum;
        }

        function getCurrentDay(date = new Date()) {
            const days = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            return days[date.getDay()];
        }

        function getYesterdayDay() {
            const days = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return days[yesterday.getDay()];
        }

        function getTomorrowDay(date = new Date()) {
            const days = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            const tomorrow = new Date(date);
            tomorrow.setDate(tomorrow.getDate() + 1);
            return days[tomorrow.getDay()];
        }
        
        // Calcola la data effettiva per un giorno specifico di una settimana
        function getDateForWeekDay(weekNum, dayName) {
            const startDate = new Date(WEEK_1_MONDAY);
            const dayIndex = getDayIndex(dayName);
            
            // Calcola quanti giorni aggiungere alla data di inizio
            const daysToAdd = (weekNum * 7) + dayIndex;
            
            const resultDate = new Date(startDate);
            resultDate.setDate(startDate.getDate() + daysToAdd);
            
            return resultDate;
        }
        
        // Formatta la data in formato italiano
        function formatDate(date) {
            const day = date.getDate();
            const month = date.getMonth() + 1;
            return `${day}/${month}`;
        }

        // Funzione per aggiungere emoji ai piatti
        function addEmojiToFood(text) {
            const emojiMap = {
                // Carne
                'pollo': 'üêî',
                'tacchino': 'ü¶É',
                'manzo': 'üêÑ',
                'bistecca': 'ü•©',
                'vitello': 'ü•©',
                'maiale': 'üê∑',
                'salsiccia': 'üå≠',
                'hamburger': 'üçî',
                'cotoletta': 'üçñ',
                'spezzatino': 'üçñ',
                'brasato': 'üçñ',
                'polpette': 'üçñ',
                
                // Pesce
                'pesce': 'üêü',
                'salmone': 'üêü',
                'tonno': 'üêü',
                'merluzzo': 'üêü',
                'orata': 'üêü',
                'frutti di mare': 'ü¶ê',
                
                // Pasta e primi
                'pasta': 'üçù',
                'spaghetti': 'üçù',
                'penne': 'üçù',
                'gnocchi': 'ü•ü',
                'risotto': 'üçö',
                'minestrone': 'ü•£',
                'minestra': 'ü•£',
                'zuppa': 'ü•£',
                
                // Verdure
                'funghi': 'üçÑ',
                'pomodoro': 'üçÖ',
                'zucca': 'üéÉ',
                'legumi': 'ü´ò',
                'ceci': 'ü´ò',
                'verdure': 'ü•¨',
                'melanzane': 'üçÜ',
                'patate': 'ü•î',
                
                // Frutta
                'mela': 'üçé',
                'pera': 'üçê',
                'banana': 'üçå',
                'arancia': 'üçä',
                'kiwi': 'ü•ù',
                'fragole': 'üçì',
                'mandarino': 'üçä',
                
                // Altro
                'frittata': 'üç≥',
                'pesto': 'üåø',
                'rag√π': 'üçñ',
                'sugo': 'üçÖ',
                'curry': 'üçõ'
            };
            
            let result = text;
            const lowerText = text.toLowerCase();
            
            // Cerca la parola chiave pi√π lunga che corrisponde (es. "frutti di mare" prima di "mare")
            const sortedKeys = Object.keys(emojiMap).sort((a, b) => b.length - a.length);
            
            for (const key of sortedKeys) {
                if (lowerText.includes(key)) {
                    result = emojiMap[key] + ' ' + result;
                    break; // Aggiungi solo un'emoji per piatto
                }
            }
            
            return result;
        }

        function createDayCard(day, meals, dayType = '', weekNum = null) {
            const card = document.createElement('div');
            let cardClass = 'day-card';
            let labelHTML = '';
            let dateHTML = '';
            
            // Aggiungi la data se viene fornito il numero di settimana
            if (weekNum !== null) {
                const date = getDateForWeekDay(weekNum, day);
                dateHTML = `<span class="day-date">${formatDate(date)}</span>`;
            }
            
            if (dayType === 'today') {
                cardClass += ' today';
                labelHTML = '<span class="day-label today-label">Oggi</span>';
            } else if (dayType === 'tomorrow') {
                cardClass += ' tomorrow';
                labelHTML = '<span class="day-label tomorrow-label">Domani</span>';
            }
            
            card.className = cardClass;
            
            // Costruisci il contenuto in base al tipo di menu
            let mealsHTML = `
                <div class="meal">
                    <h3>Primo</h3>
                    <p>${meals.primo}</p>
                </div>
                <div class="meal">
                    <h3>Secondo</h3>
                    <p>${meals.secondo}</p>
                </div>`;
            
            // Aggiungi contorno solo per menu infanzia
            if (meals.contorno) {
                mealsHTML += `
                <div class="meal">
                    <h3>Contorno</h3>
                    <p>${meals.contorno}</p>
                </div>`;
            }
            
            mealsHTML += `
                <div class="meal">
                    <h3>Frutta</h3>
                    <p>${meals.frutta}</p>
                </div>`;
            
            card.innerHTML = `
                <h2><span>${day}</span>${dateHTML}${labelHTML}</h2>
                ${mealsHTML}
            `;
            
            return card;
        }

        function getDayIndex(dayName) {
            const dayOrder = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            return dayOrder.indexOf(dayName);
        }

        // Verifica se il giorno corrente √® domenica (il sabato ha attivit√†)
        function isWeekend(date = new Date()) {
            const day = getCurrentDay(date);
            return day === 'Domenica';
        }

        function displayQuickView() {
            const today = new Date();
            const currentDay = getCurrentDay(today);
            const isWeekendDay = isWeekend(today);
            
            // Se √® domenica, mostra il prossimo luned√¨
            let displayWeek = getWeekNumber(today);
            let displayStartDay = currentDay;
            
            if (isWeekendDay) {
                // Trova il prossimo luned√¨
                const nextMonday = new Date(today);
                const daysUntilMonday = 1; // Domenica -> Luned√¨
                nextMonday.setDate(today.getDate() + daysUntilMonday);
                
                displayWeek = getWeekNumber(nextMonday);
                displayStartDay = 'Luned√¨';
            }
            
            const menu = getCurrentMenu()[displayWeek];
            const currentDayIndex = getDayIndex(displayStartDay);
            const tomorrowDay = getTomorrowDay(today);
            
            const quickView = document.getElementById('quick-view');
            quickView.innerHTML = '';
            
            // Calculate week date range
            const weekStartDate = getDateForWeekDay(displayWeek, 'Luned√¨');
            const weekEndDate = getDateForWeekDay(displayWeek, 'Venerd√¨');
            const dateRangeText = `${formatDate(weekStartDate)} - ${formatDate(weekEndDate)}`;
            
            // Add week header
            const weekHeader = document.createElement('div');
            weekHeader.className = `quick-view-header week-${displayWeek + 1}`;
            const weekTitle = isWeekendDay
                ? `Prossima Settimana (Settimana ${displayWeek + 1})`
                : `Settimana ${displayWeek + 1}`;
            weekHeader.innerHTML = `<h2>${weekTitle} <small style="font-size:0.8em; font-weight:400;">(${dateRangeText})</small></h2>`;
            quickView.appendChild(weekHeader);
            
            const menuContainer = document.createElement('div');
            menuContainer.className = 'menu-container compact';
            
            // Build list of days to show (only from today onwards)
            const daysToShow = [];
            
            for (const [day, meals] of Object.entries(menu)) {
                const dayIndex = getDayIndex(day);
                
                // Only show days from today onwards
                if (dayIndex >= currentDayIndex) {
                    let dayType = '';
                    let order = dayIndex;
                    
                    // Non evidenziare oggi e domani se √® weekend
                    if (!isWeekendDay) {
                        if (day === displayStartDay) {
                            dayType = 'today';
                            order = 0;
                        } else if (day === tomorrowDay) {
                            dayType = 'tomorrow';
                            order = 1;
                        }
                    }
                    
                    daysToShow.push({ day, meals, dayType, order });
                }
            }
            
            // Sort to ensure today comes first, then tomorrow, then remaining days in order
            daysToShow.sort((a, b) => a.order - b.order);
            
            // Add all cards
            daysToShow.forEach(item => {
                menuContainer.appendChild(createDayCard(item.day, item.meals, item.dayType, displayWeek));
            });
            
            quickView.appendChild(menuContainer);
        }


        function displayAllWeeks() {
            const today = new Date();
            const currentWeek = getWeekNumber();
            const currentDay = getCurrentDay();
            const tomorrowDay = getTomorrowDay();
            const isWeekendDay = isWeekend(today);
            
            // Se √® weekend, la settimana "corrente" da visualizzare √® la prossima
            let displayCurrentWeek = currentWeek;
            if (isWeekendDay) {
                const nextMonday = new Date(today);
                const daysUntilMonday = currentDay === 'Sabato' ? 2 : 1;
                nextMonday.setDate(today.getDate() + daysUntilMonday);
                displayCurrentWeek = getWeekNumber(nextMonday);
            }
            
            const weeksContent = document.getElementById('weeks-content');
            weeksContent.innerHTML = '';
            
            // Mark current week in timeline
            markCurrentWeekInTimeline(displayCurrentWeek + 1);
            
            // Show weeks in order 1, 2, 3, 4 (not based on current week)
            for (let weekNum = 0; weekNum < 4; weekNum++) {
                const isCurrentWeek = weekNum === displayCurrentWeek;
                const menu = getCurrentMenu()[weekNum];
                
                const weekSection = document.createElement('div');
                // Add both week color class and current-week class if applicable
                const weekColorClass = `week-${weekNum + 1}`;
                weekSection.className = `week-section ${weekColorClass}${isCurrentWeek ? ' current-week' : ''}`;
                weekSection.id = `week-${weekNum + 1}`; // Add ID for scrolling
                weekSection.setAttribute('data-week', weekNum + 1);
                
                // Calculate week date range
                const weekStartDate = getDateForWeekDay(weekNum, 'Luned√¨');
                const weekEndDate = getDateForWeekDay(weekNum, 'Venerd√¨');
                const dateRangeText = `${formatDate(weekStartDate)} - ${formatDate(weekEndDate)}`;
                
                const weekTitle = document.createElement('h2');
                weekTitle.className = 'week-title';
                weekTitle.innerHTML = `Settimana ${weekNum + 1} <small style="font-size:0.75em; font-weight:400; color:#666;">(${dateRangeText})</small>${isCurrentWeek ? '<span class="current-badge">Settimana Corrente</span>' : ''}`;
                weekSection.appendChild(weekTitle);
                
                const menuContainer = document.createElement('div');
                menuContainer.className = 'menu-container';
                
                // Mostra i giorni nell'ordine corretto (Luned√¨-Venerd√¨)
                const dayOrder = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨'];
                for (const day of dayOrder) {
                    const meals = menu[day];
                    if (meals) {
                        let dayType = '';
                        // Non evidenziare oggi e domani se √® weekend
                        if (isCurrentWeek && !isWeekendDay) {
                            if (day === currentDay) dayType = 'today';
                            else if (day === tomorrowDay) dayType = 'tomorrow';
                        }
                        
                        menuContainer.appendChild(createDayCard(day, meals, dayType, weekNum));
                    }
                }
                
                weekSection.appendChild(menuContainer);
                weeksContent.appendChild(weekSection);
            }
            
            // Setup intersection observer for timeline
            setupWeekObserver();
            
            // Scroll to current week after a short delay to ensure rendering is complete
            setTimeout(() => {
                scrollToWeek(displayCurrentWeek + 1, false);
            }, 100);
        }

        // Mark current week in timeline (permanent indicator)
        function markCurrentWeekInTimeline(currentWeekNum) {
            document.querySelectorAll('.timeline-item').forEach(item => {
                const weekNum = parseInt(item.getAttribute('data-week'));
                if (weekNum === currentWeekNum) {
                    item.classList.add('current');
                } else {
                    item.classList.remove('current');
                }
            });
        }


        function toggleAllWeeks() {
            const quickView = document.getElementById('quick-view');
            const allWeeksContainer = document.getElementById('all-weeks-container');
            const btnAllWeeks = document.getElementById('btn-all-weeks');
            
            if (allWeeksContainer.classList.contains('hidden')) {
                // Show all weeks
                quickView.classList.add('hidden');
                allWeeksContainer.classList.remove('hidden');
                
                btnAllWeeks.textContent = 'Nascondi';
                btnAllWeeks.classList.remove('btn-secondary');
                btnAllWeeks.classList.add('btn-primary');
                
                displayAllWeeks();
            } else {
                // Hide all weeks, show quick view
                quickView.classList.remove('hidden');
                allWeeksContainer.classList.add('hidden');
                
                btnAllWeeks.textContent = 'Tutte le Settimane';
                btnAllWeeks.classList.remove('btn-primary');
                btnAllWeeks.classList.add('btn-secondary');
            }
        }

        // Setup Intersection Observer to track which week is visible
        function setupWeekObserver() {
            const options = {
                root: null,
                rootMargin: '-20% 0px -60% 0px',
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const weekNum = entry.target.getAttribute('data-week');
                        updateTimeline(parseInt(weekNum));
                    }
                });
            }, options);

            // Observe all week sections
            document.querySelectorAll('.week-section').forEach(section => {
                observer.observe(section);
            });
        }

        // Update timeline to highlight active week
        function updateTimeline(weekNum) {
            document.querySelectorAll('.timeline-item').forEach(item => {
                if (parseInt(item.getAttribute('data-week')) === weekNum) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Scroll to specific week
        function scrollToWeek(weekNum, smooth = true) {
            const weekElement = document.getElementById(`week-${weekNum}`);
            if (weekElement) {
                const offset = 80; // Offset for sticky timeline
                const elementPosition = weekElement.getBoundingClientRect().top + window.pageYOffset;
                const offsetPosition = elementPosition - offset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: smooth ? 'smooth' : 'auto'
                });

                updateTimeline(weekNum);
            }
        }

        // Switch between tabs (Favorites / Menu / Activities / Preferences)
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Get all sections
            const favoritesSection = document.getElementById('favorites-section');
            const menuSection = document.getElementById('menu-section');
            const activitiesSection = document.getElementById('activities-section');
            const preferencesSection = document.getElementById('preferences-section');
            
            // Hide all sections
            favoritesSection.classList.add('hidden');
            menuSection.classList.add('hidden');
            activitiesSection.classList.add('hidden');
            preferencesSection.classList.add('hidden');
            
            // Show selected section
            if (tab === 'favorites') {
                favoritesSection.classList.remove('hidden');
                displayFavorites();
            } else if (tab === 'menu') {
                menuSection.classList.remove('hidden');
            } else if (tab === 'activities') {
                activitiesSection.classList.remove('hidden');
                displayActivities();
            } else if (tab === 'preferences') {
                preferencesSection.classList.remove('hidden');
                displayPreferences();
            }
        }

        // Select menu type (Nido / Infanzia)
        function selectMenuType(type) {
            currentMenuType = type;
            
            // Update selector buttons
            document.querySelectorAll('#menu-section .selector-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Refresh menu display
            const allWeeksContainer = document.getElementById('all-weeks-container');
            if (allWeeksContainer.classList.contains('hidden')) {
                displayQuickView();
            } else {
                displayAllWeeks();
            }
        }

        // Select activity group
        function selectActivityGroup(group) {
            currentActivityGroup = group;
            
            // Update selector buttons
            document.querySelectorAll('#activities-section .selector-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Refresh activities display
            displayActivities();
        }

        // Display activities for selected group
        function displayActivities() {
            const today = new Date();
            const currentDay = getCurrentDay(today);
            const tomorrowDay = getTomorrowDay(today);
            
            const activitiesContent = document.getElementById('activities-content');
            activitiesContent.innerHTML = '';
            
            const activities = ACTIVITIES[currentActivityGroup];
            
            if (!activities || Object.keys(activities).length === 0) {
                activitiesContent.innerHTML = '<p style="text-align: center; color: #999;">Nessuna attivit√† disponibile per questo gruppo.</p>';
                return;
            }
            
            const activityWeek = document.createElement('div');
            activityWeek.className = 'activity-week';
            
            // Group label mapping
            const groupLabels = {
                'nido': 'üë∂ Nido',
                'primavera': 'üå∏ Primavera',
                'infanzia1': 'üéì Infanzia 1',
                'infanzia2': 'üéì Infanzia 2'
            };
            
            const weekTitle = document.createElement('h2');
            weekTitle.className = 'activity-week-title';
            weekTitle.textContent = `Attivit√† Settimanali - ${groupLabels[currentActivityGroup]}`;
            activityWeek.appendChild(weekTitle);
            
            const activitiesGrid = document.createElement('div');
            activitiesGrid.className = 'activities-grid';
            
            // Show days in order (Monday to Saturday)
            const dayOrder = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            for (const day of dayOrder) {
                const moments = activities[day];
                if (moments) {
                    const dayCard = createActivityDayCard(day, moments, currentDay, tomorrowDay);
                    activitiesGrid.appendChild(dayCard);
                }
            }
            
            activityWeek.appendChild(activitiesGrid);
            activitiesContent.appendChild(activityWeek);
        }

        // Create activity day card
        function createActivityDayCard(day, moments, currentDay, tomorrowDay) {
            const card = document.createElement('div');
            let cardClass = 'activity-day-card';
            
            if (day === currentDay) {
                cardClass += ' today';
            } else if (day === tomorrowDay) {
                cardClass += ' tomorrow';
            }
            
            card.className = cardClass;
            
            let momentsHTML = '';
            for (let i = 0; i < moments.length && i < ACTIVITY_MOMENTS.length; i++) {
                momentsHTML += `
                    <div class="activity-moment">
                        <div class="activity-moment-title">${ACTIVITY_MOMENTS[i]}</div>
                        <div class="activity-moment-content">${moments[i]}</div>
                    </div>`;
            }
            
            card.innerHTML = `
                <h3>${day}</h3>
                ${momentsHTML}
            `;
            
            return card;
        }

        // Open combination modal
        function openCombinationModal(combinationId = null) {
            const modal = document.getElementById('combination-modal');
            const modalTitle = document.getElementById('modal-title');
            const form = document.getElementById('combination-form');
            
            if (combinationId) {
                // Edit mode
                editingCombinationId = combinationId;
                const combination = combinations.find(c => c.id === combinationId);
                
                if (combination) {
                    modalTitle.textContent = 'Modifica Combinazione';
                    document.getElementById('combination-name').value = combination.name;
                    document.getElementById('combination-menu').value = combination.menuType;
                    document.getElementById('combination-activity').value = combination.activityGroup;
                }
            } else {
                // Add mode
                editingCombinationId = null;
                modalTitle.textContent = 'Nuova Combinazione';
                form.reset();
            }
            
            modal.classList.add('active');
        }

        // Close combination modal
        function closeCombinationModal() {
            const modal = document.getElementById('combination-modal');
            modal.classList.remove('active');
            editingCombinationId = null;
        }

        // Handle combination form submit
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('combination-form');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('combination-name').value.trim();
                const menuType = document.getElementById('combination-menu').value;
                const activityGroup = document.getElementById('combination-activity').value;
                
                if (editingCombinationId) {
                    // Update existing combination
                    const index = combinations.findIndex(c => c.id === editingCombinationId);
                    if (index !== -1) {
                        combinations[index] = {
                            ...combinations[index],
                            name,
                            menuType,
                            activityGroup
                        };
                    }
                } else {
                    // Add new combination
                    combinations.push({
                        id: generateId(),
                        name,
                        menuType,
                        activityGroup
                    });
                }
                
                saveCombinations();
                closeCombinationModal();
                displayPreferences();
                
                // Update favorites if visible
                if (currentTab === 'favorites') {
                    displayFavorites();
                }
            });

            // Close modal when clicking outside
            const modal = document.getElementById('combination-modal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeCombinationModal();
                }
            });
        });

        // Delete combination
        function deleteCombination(combinationId) {
            if (confirm('Sei sicuro di voler eliminare questa combinazione?')) {
                combinations = combinations.filter(c => c.id !== combinationId);
                saveCombinations();
                displayPreferences();
                
                // Update favorites if visible
                if (currentTab === 'favorites') {
                    displayFavorites();
                }
            }
        }

        // Move combination up
        function moveCombinationUp(combinationId) {
            const index = combinations.findIndex(c => c.id === combinationId);
            if (index > 0) {
                // Swap with previous
                [combinations[index - 1], combinations[index]] = [combinations[index], combinations[index - 1]];
                saveCombinations();
                displayPreferences();
                
                // Update favorites if visible
                if (currentTab === 'favorites') {
                    displayFavorites();
                }
            }
        }

        // Move combination down
        function moveCombinationDown(combinationId) {
            const index = combinations.findIndex(c => c.id === combinationId);
            if (index >= 0 && index < combinations.length - 1) {
                // Swap with next
                [combinations[index], combinations[index + 1]] = [combinations[index + 1], combinations[index]];
                saveCombinations();
                displayPreferences();
                
                // Update favorites if visible
                if (currentTab === 'favorites') {
                    displayFavorites();
                }
            }
        }

        // Display preferences (combinations list)
        function displayPreferences() {
            const container = document.getElementById('combinations-list');
            container.innerHTML = '';
            
            if (combinations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">Nessuna combinazione salvata. Clicca sul pulsante sopra per aggiungerne una.</p>';
                return;
            }
            
            // Labels mapping
            const menuLabels = {
                'nido': 'üë∂ Nido',
                'infanzia': 'üéì Infanzia'
            };
            
            const activityLabels = {
                'nido': 'üë∂ Nido',
                'primavera': 'üå∏ Primavera',
                'infanzia1': 'üéì Infanzia 1',
                'infanzia2': 'üéì Infanzia 2'
            };
            
            combinations.forEach((combination, index) => {
                const card = document.createElement('div');
                card.className = 'combination-card';
                
                // Controlli ordinamento
                const isFirst = index === 0;
                const isLast = index === combinations.length - 1;
                
                card.innerHTML = `
                    <div class="combination-header">
                        <div class="combination-name">${combination.name}</div>
                        <div class="combination-actions">
                            <div class="order-controls">
                                <button class="action-btn move" onclick="moveCombinationUp('${combination.id}')" ${isFirst ? 'disabled style="opacity: 0.3; cursor: not-allowed;"' : ''}>‚¨ÜÔ∏è</button>
                                <button class="action-btn move" onclick="moveCombinationDown('${combination.id}')" ${isLast ? 'disabled style="opacity: 0.3; cursor: not-allowed;"' : ''}>‚¨áÔ∏è</button>
                            </div>
                            <button class="action-btn edit" onclick="openCombinationModal('${combination.id}')">‚úèÔ∏è Modifica</button>
                            <button class="action-btn delete" onclick="deleteCombination('${combination.id}')">üóëÔ∏è Elimina</button>
                        </div>
                    </div>
                    <div class="combination-content">
                        <div class="combination-section">
                            <h4>üìã Menu</h4>
                            <p>${menuLabels[combination.menuType]}</p>
                        </div>
                        <div class="combination-section">
                            <h4>üé® Attivit√†</h4>
                            <p>${activityLabels[combination.activityGroup]}</p>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Display favorites (combined daily view of menu and activities)
        function displayFavorites() {
            const container = document.getElementById('favorites-content');
            container.innerHTML = '';
            
            if (combinations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <p style="color: #999; font-size: 1.1rem; margin-bottom: 1rem;">Non hai ancora salvato nessuna combinazione</p>
                        <button class="btn btn-primary" onclick="switchTab('preferences')" style="display: inline-block;">
                            ‚öôÔ∏è Vai alle Preferenze
                        </button>
                    </div>
                `;
                return;
            }
            
            const today = new Date();
            const currentDay = getCurrentDay(today);
            
            // Labels mapping
            const menuLabels = {
                'nido': 'üë∂ Nido',
                'infanzia': 'üéì Infanzia'
            };
            
            const activityLabels = {
                'nido': 'üë∂ Nido',
                'primavera': 'üå∏ Primavera',
                'infanzia1': 'üéì Infanzia 1',
                'infanzia2': 'üéì Infanzia 2'
            };
            
            combinations.forEach((combination, index) => {
                const combinationCard = document.createElement('div');
                combinationCard.className = 'favorite-combination';
                combinationCard.id = `favorite-${combination.id}`;
                
                // Determine if toggle should be shown (only Monday-Friday)
                const dayIndex = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨'].indexOf(currentDay);
                const showToggle = dayIndex >= 0 && dayIndex < 4; // Monday to Thursday
                
                // Create toggle HTML
                const toggleHTML = showToggle ? `
                    <div class="day-toggle">
                        <button class="day-toggle-btn active" onclick="toggleFavoriteDay('${combination.id}', 'today')">
                            üìÖ Oggi
                        </button>
                        <button class="day-toggle-btn" onclick="toggleFavoriteDay('${combination.id}', 'tomorrow')">
                            üìÖ Domani
                        </button>
                    </div>
                ` : '';
                
                combinationCard.innerHTML = `
                    <div class="favorite-combination-header">
                        <h3>‚≠ê ${combination.name}</h3>
                    </div>
                    ${toggleHTML}
                    <div id="day-content-${combination.id}">
                        <!-- Content will be loaded here -->
                    </div>
                `;
                
                container.appendChild(combinationCard);
                
                // Load today's content by default
                loadFavoriteDayContent(combination.id, 'today');
            });
        }

        // Load content for a specific day in favorites
        function loadFavoriteDayContent(combinationId, dayType) {
            const combination = combinations.find(c => c.id === combinationId);
            if (!combination) return;
            
            const today = new Date();
            const currentDay = getCurrentDay(today);
            const currentWeek = getWeekNumber(today);
            const isWeekendDay = isWeekend(today);
            
            // Calculate display day and week
            let displayDay = currentDay;
            let displayWeek = currentWeek;
            let dayLabel = '';
            
            if (isWeekendDay) {
                // If Sunday, show next Monday (tomorrow)
                const nextMonday = new Date(today);
                nextMonday.setDate(today.getDate() + 1);
                displayWeek = getWeekNumber(nextMonday);
                displayDay = 'Luned√¨';
                dayLabel = 'Domani - Luned√¨';
            } else if (dayType === 'tomorrow') {
                // Get tomorrow
                const tomorrow = getTomorrowDay(today);
                const tomorrowDate = new Date(today);
                tomorrowDate.setDate(today.getDate() + 1);
                displayWeek = getWeekNumber(tomorrowDate);
                displayDay = tomorrow;
                dayLabel = `Domani - ${tomorrow}`;
            } else {
                // Today
                dayLabel = displayDay === 'Sabato' ? 'Oggi - Sabato' : `Oggi - ${displayDay}`;
            }
            
            // Get menu data
            const menuData = combination.menuType === 'nido' ? MENU_NIDO : MENU_INFANZIA;
            const dayMenu = (displayDay !== 'Sabato') ? (menuData[displayWeek] && menuData[displayWeek][displayDay]) : null;
            
            // Get activities data
            const dayActivities = ACTIVITIES[combination.activityGroup] && ACTIVITIES[combination.activityGroup][displayDay];
            
            // Create menu HTML (solo se non √® sabato)
            let menuHTML = '';
            if (dayMenu) {
                menuHTML = `
                    <div class="favorite-menu-items">
                        <div class="meal">
                            <h4>üçù Primo</h4>
                            <p>${dayMenu.primo}</p>
                        </div>
                        <div class="meal">
                            <h4>üçñ Secondo</h4>
                            <p>${dayMenu.secondo}</p>
                        </div>`;
                
                if (dayMenu.contorno) {
                    menuHTML += `
                        <div class="meal">
                            <h4>ü•ó Contorno</h4>
                            <p>${dayMenu.contorno}</p>
                        </div>`;
                }
                
                menuHTML += `
                        <div class="meal">
                            <h4>üçé Frutta</h4>
                            <p>${dayMenu.frutta}</p>
                        </div>
                    </div>`;
            } else {
                menuHTML = '<p class="no-data-message">Dati menu non disponibili</p>';
            }
            
            // Create activities HTML
            let activitiesHTML = '';
            if (dayActivities && dayActivities.length > 0) {
                activitiesHTML = '<div class="favorite-activities-list">';
                for (let i = 0; i < dayActivities.length && i < ACTIVITY_MOMENTS.length; i++) {
                    activitiesHTML += `
                        <div class="activity-moment">
                            <div class="activity-moment-title">${ACTIVITY_MOMENTS[i]}</div>
                            <div class="activity-moment-content">${dayActivities[i]}</div>
                        </div>`;
                }
                activitiesHTML += '</div>';
            } else {
                activitiesHTML = '<p class="no-data-message">Dati attivit√† non disponibili</p>';
            }
            
            // Update content
            const contentDiv = document.getElementById(`day-content-${combinationId}`);
            if (contentDiv) {
                // Se √® sabato, mostra solo attivit√† (senza menu)
                if (displayDay === 'Sabato') {
                    contentDiv.innerHTML = `
                        <div style="text-align: center; margin: 1rem 0;">
                            <span class="combination-badge">üìÖ ${dayLabel}</span>
                        </div>
                        <div class="favorite-activities-section" style="max-width: 800px; margin: 0 auto;">
                            <div class="favorite-section-title">
                                <span>üé® Attivit√† del Giorno</span>
                            </div>
                            ${activitiesHTML}
                        </div>
                    `;
                } else {
                    // Altri giorni: mostra menu e attivit√†
                    contentDiv.innerHTML = `
                        <div style="text-align: center; margin: 1rem 0;">
                            <span class="combination-badge">üìÖ ${dayLabel}</span>
                        </div>
                        <div class="favorite-day-view">
                            <div class="favorite-menu-section">
                                <div class="favorite-section-title">
                                    <span>üçΩÔ∏è Menu del Giorno</span>
                                </div>
                                ${menuHTML}
                            </div>
                            <div class="favorite-activities-section">
                                <div class="favorite-section-title">
                                    <span>üé® Attivit√† del Giorno</span>
                                </div>
                                ${activitiesHTML}
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Toggle between today and tomorrow in favorites
        function toggleFavoriteDay(combinationId, dayType) {
            // Update button states
            const card = document.getElementById(`favorite-${combinationId}`);
            if (card) {
                const buttons = card.querySelectorAll('.day-toggle-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    if ((dayType === 'today' && btn.textContent.includes('Oggi')) ||
                        (dayType === 'tomorrow' && btn.textContent.includes('Domani'))) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Load content for selected day
            loadFavoriteDayContent(combinationId, dayType);
        }

        // View combination menu
        function viewCombinationMenu(combinationId) {
            const combination = combinations.find(c => c.id === combinationId);
            if (combination) {
                currentMenuType = combination.menuType;
                switchTab('menu');
                
                // Update menu selector
                document.querySelectorAll('#menu-section .selector-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`#menu-section .selector-btn[onclick*="${combination.menuType}"]`)?.classList.add('active');
                
                displayQuickView();
            }
        }

        // View combination activities
        function viewCombinationActivities(combinationId) {
            const combination = combinations.find(c => c.id === combinationId);
            if (combination) {
                currentActivityGroup = combination.activityGroup;
                switchTab('activities');
                
                // Update activity selector
                document.querySelectorAll('#activities-section .selector-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`#activities-section .selector-btn[onclick*="${combination.activityGroup}"]`)?.classList.add('active');
                
                displayActivities();
            }
        }

        // Initialize app: load menu and display
        async function initApp() {
            loadCombinations();
            await loadAllDataFiles();
            displayQuickView();
            
            // Display configured date in footer
            const configDateElement = document.getElementById('config-date');
            if (configDateElement) {
                const startDate = new Date(WEEK_1_MONDAY);
                const formattedDate = startDate.toLocaleDateString('it-IT', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                configDateElement.textContent = formattedDate;
            }
        }

        // Start app when page loads
        initApp();
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Forza controllo aggiornamenti service worker ogni volta
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registrato con successo:', registration.scope);
                        
                        // Controlla aggiornamenti ogni volta che si apre l'app
                        registration.update();
                        
                        // Se c'√® un nuovo service worker in attesa, attivalo
                        if (registration.waiting) {
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        }
                        
                        // Ascolta per nuovi service worker
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nuovo service worker disponibile - ricarica la pagina
                                    console.log('Nuovo service worker disponibile, ricarico...');
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('Registrazione Service Worker fallita:', error);
                    });
                
                // Ricarica quando il service worker prende il controllo
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        refreshing = true;
                        window.location.reload();
                    }
                });
            });
        }
        
        // PWA Install Prompt Handler
        let deferredPrompt;
        const installButton = document.getElementById('btn-install');
        
        // Intercetta l'evento beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            // Previeni il prompt automatico del browser
            e.preventDefault();
            // Salva l'evento per poterlo utilizzare dopo
            deferredPrompt = e;
            // Mostra il pulsante di installazione
            installButton.style.display = 'block';
            console.log('Prompt di installazione catturato');
        });
        
        // Gestisci il click sul pulsante di installazione
        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                console.log('Nessun prompt di installazione disponibile');
                return;
            }
            
            // Mostra il prompt di installazione
            deferredPrompt.prompt();
            
            // Aspetta la scelta dell'utente
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`Scelta utente: ${outcome}`);
            
            if (outcome === 'accepted') {
                console.log('Utente ha accettato l\'installazione');
            } else {
                console.log('Utente ha rifiutato l\'installazione');
            }
            
            // Resetta il prompt
            deferredPrompt = null;
            // Nascondi il pulsante
            installButton.style.display = 'none';
        });
        
        // Nascondi il pulsante se l'app √® gi√† installata
        window.addEventListener('appinstalled', () => {
            console.log('PWA installata con successo!');
            installButton.style.display = 'none';
            deferredPrompt = null;
        });
        
        // Controlla se l'app √® gi√† in modalit√† standalone (gi√† installata)
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
            console.log('App gi√† installata - nascondo pulsante');
            installButton.style.display = 'none';
        }
    </script>
</body>
</html>
